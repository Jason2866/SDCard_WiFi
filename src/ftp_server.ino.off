/*
 * FtpServer Arduino
 * With SdFat version > 2 (full name and more size)
 *
 * https://www.mischianti.org/2020/02/08/ftp-server-on-esp8266-and-esp32
 *
 */

#include <Arduino.h>
#include <SdFat.h>
#include <sdios.h>
#include <FtpServer.h>
#include <FreeStack.h>

// Define Chip Select for your SD card according to hardware
#define CS_SDCARD 4 // Chip Select for SD card reader on Due

// Object for File system
SdFat sd;

#undef DEFAULT_STORAGE_TYPE_ARDUINO
#define DEFAULT_STORAGE_TYPE_ARDUINO STORAGE_SDFAT2

// Object for FtpServer
//  Command port and Data port in passive mode can be defined here
// FtpServer ftpSrv( 221, 25000 );
// FtpServer ftpSrv( 421 ); // Default data port in passive mode is 55600
FtpServer ftpSrv; // Default command port is 21 ( !! without parenthesis !! )

// IP address of FTP server
// if set to 0, use DHCP for the routeur to assign IP
// IPAddress serverIp( 192, 168, 1, 40 );
IPAddress serverIp( 0, 0, 0, 0 );

// External IP address of FTP server
// In passive mode, when accessing the serveur from outside his subnet, it can be
//  necessary with some clients to reply them with the server's external ip address
// IPAddress externalIp( 192, 168, 1, 2 );

ArduinoOutStream cout( Serial );


void setup()
{
  Serial.begin( 115200 );
  cout << F("=== Test of FTP Server with SdFat ") << SD_FAT_VERSION << F(" file system ===") << endl;

  // Mount the SD card memory
  cout << F("Mount the SD card memory... ");
  if( ! sd.begin( CS_SDCARD, SD_SCK_MHZ( 50 )))
  {
    cout << F("Unable to mount SD card") << endl;
    while( true ) ;
  }
  pinMode( CS_SDCARD, OUTPUT );
  digitalWrite( CS_SDCARD, HIGH );
  cout << F("ok") << endl;

  // Show capacity and free space of SD card
  cout << F("Capacity of card:   ") << long( sd.card()->sectorCount() >> 1 )
       << F(" kBytes") << endl;
  cout << F("Free space on card: ")
       << long( sd.vol()->freeClusterCount() * sd.vol()->sectorsPerCluster() >> 1 )
       << F(" kBytes") << endl;



  // Initialize the FTP server
  ftpSrv.begin("user","password");
  // ftpSrv.init( externalIp );
  // ftpSrv.init( IPAddress( 11, 22, 33, 44 ));

  // Default username and password are set to 'arduino' and 'test'
  //  but can then be changed by calling ftpSrv.credentials()
  // ftpSrv.credentials( "myname", "123" );

  cout << F("Free stack: ") << FreeStack() << endl;

  cout << "Viaaa!";
}

void loop()
{
  ftpSrv.handleFTP();

  // more processes...
}
